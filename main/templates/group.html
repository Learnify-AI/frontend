{% extends 'base.html' %}

{% block title %} Groups {% endblock %}
{% block text %}Create Group{%endblock%}
{% block content%}

{% if user_groups %}
<h3>Your Groups</h3>
<div class="row">
  {% for group in user_groups %}
    <div class="col-md-12 col-sm-12 col-lg-6 col-xl-6">
        <div class="dash-widget">
            <span class="dash-widget-bg"><i class="fa fa-book" aria-hidden="true"></i></span>
            <div class="dash-widget-info">
                <h3>{{ group.name }}</h3>
                <span class="widget-title1">{{group.school}}</i></span><br>
                <span class="widget-title2">{{group.current_no_users}} members</i></span>
            </div>
            <button class="start-quiz button-upload view-courses" data-groupid="{{group.id}}">View Courses</button>
        </div>
    </div>
  {% endfor %}
</div>
{% endif %}
{% if public_groups %}
<h3>Public Groups</h3>
<div class="row">
  {% for group in public_groups %}
    <div class="col-md-12 col-sm-12 col-lg-6 col-xl-6">
        <div class="dash-widget">
            <span class="dash-widget-bg"><i class="fa fa-book" aria-hidden="true"></i></span>
            <div class="dash-widget-info">
              <h3>{{ group.name }}</h3>
              <span class="widget-title1">{{group.school}}</i></span><br>
              <span class="widget-title2">{{group.current_no_users}} members</i></span>
            </div>
            {% if user in group.users %}
            <!-- {{group.users[0].id}} -->
            <button class="start-quiz button-upload view-courses" data-groupid="{{group.id}}" >View Courses</button>
            {% else %}
            <button class="start-quiz button-upload" data-toggle="modal" data-target="#joingroup" data-groupid="{{group.id}}" data-groupkey="{{group.pass_key}}">Join Group</button>
            {% endif %}
        </div>
    </div>
  {% endfor %}
{% endif %}
    <!-- <div class="col-md-12 col-sm-12 col-lg-6 col-xl-6">
        <div class="dash-widget">
            <span class="dash-widget-bg"><i class="fa fa-user-md"></i></span>
            <div class="dash-widget-info text-right">
                <h3>CPE 300LVL</h3>
                <span class="widget-title1">uniben</i></span><br>
                <span class="widget-title2">50 members</i></span>
            </div>
            <button class="start-quiz button-upload" data-link="/courses/{{user_id}}" data-toggle="modal" data-target="#joingroup" data-groupid="123234">Join Group</button>
        </div>
    </div>
    <div class="col-md-12 col-sm-12 col-lg-6 col-xl-6">
        <div class="dash-widget">
            <span class="dash-widget-bg"><i class="fa fa-user-md" aria-hidden="true"></i></span>
            <div class="dash-widget-info text-right">
                <h3>CVE 300LVL</h3>
                <span class="widget-title1">uniben</i></span><br>
                <span class="widget-title2">20 members</i></span>
            </div>
            <button class="start-quiz button-upload" data-link="/courses/{{user_id}}" data-toggle="modal" data-target="#joingroup" data-groupid="1234231">Join Group</button>
        </div>
    </div>
    <div class="col-md-12 col-sm-12 col-lg-6 col-xl-6">
        <div class="dash-widget">
            <span class="dash-widget-bg"><i class="fa fa-heartbeat" aria-hidden="true"></i></span>
            <div class="dash-widget-info text-right">
                <h3>PRE 400LVL</h3>
                <span class="widget-title1">uniben</i></span><br>
                <span class="widget-title2">60 members</i></span>
            </div>
            <button class="start-quiz button-upload" data-link="/courses/{{user_id}}" data-toggle="modal" data-target="#joingroup" data-groupid="123465">Join Group</button>
        </div>
    </div>
</div>-->
<div class="modal fade" id="joingroup" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Enter Group Access Pin</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form>
          <div class="form-group">
            <label for="group-access" class="col-form-label">Access Pin:</label>
            <input type="text" name="group-access" class="form-control" id="group-access" placeholder="default pin is 1234">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button type="submit" id="button-pin" class="button-upload">Enter</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div> 
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Create Group</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form method="post" id="groupForm" action="/user/create-group-key/{{user.id}}">
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="has-id">
                <label class="form-check-label" for="has-id">Has ID</label>
            </div>
            <div class="form-group group-name">
                <label for="group-name" class="col-form-label">Group Name:</label>
                <input type="text" name="group-name" class="form-control" id="group-name">
            </div>
            <div class="form-group school">
                <label for="school" class="col-form-label">School:</label>
                <input type="text" name="school" class="form-control" id="school">
            </div>
            <div class="form-group max-occupance">
                <label for="max-occupance" class="col-form-label">Max Occupancy:</label>
                <input type="number" name="max-occupancy" class="form-control" id="max-occupance">
            </div>
            <div class="form-group">
                <label for="enter-id" class="col-form-label">Enter ID:</label>
                <input type="text" disabled name="group-id" class="form-control" id="enter-id">
            </div>
            <div class="form-group" id="group-pin">
                <label for="group-pin" class="col-form-label">Enter Group Password:</label>
                <input type="password" name="group-pin" class="form-control" id="enter-id">
              </div>
              <div class="form-group">
                <label for="description" class="col-form-label">Description</label>
                <textarea class="form-control" name="description" id="description"></textarea>
              </div>
              <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" id="button-up" class="button-upload">Request ID</button>
            </div>
          </form>
        </div>
      </div>
    </div>
</div>
{% endblock content%}
{% block script%}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      var checkbox = document.getElementById('has-id');
      var addUserButton = document.getElementById('button-pin');
      var enterIdInput = document.getElementById('enter-id');
      var groupName = document.querySelector('.group-name');
      var maxOccupance = document.querySelector('.max-occupance');
      var school = document.querySelector('.school');
      var button = document.querySelector('#button-up');
      var groupPin = document.querySelector('#group-pin')
      var form = document.getElementById('groupForm');
      var userId = "{{user.id}}"
      console.log(userId)
      groupPin.style.display = "none"

      checkbox.addEventListener('change', function() {
        if (this.checked) {
          enterIdInput.removeAttribute('disabled');
          button.textContent = 'Proceed';
          groupPin.style.display = "block";
          groupName.style.display = "none";
          school.style.display = "none";
          maxOccupance.style.display = "none";
          form.action = '/user/create-group/{{user.id}}';
        } else {
          enterIdInput.setAttribute('disabled', 'disabled');
          button.textContent = 'Request ID';
          groupPin.style.display = "none"
          groupName.style.display = "block";
          school.style.display = "block";
          maxOccupance.style.display = "block";
          form.action = '/user/create-group-key/{{user.id}}';
        }
      });
    }); 
  </script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>

    $(document).ready(function () {
      let groupId, groupKey;
      console.log("here")
        $('#joingroup').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Button that triggered the modal
            groupId = button.data('groupid'); // Extract group ID from data-groupid attribute
            groupKey = button.data('groupkey'); // Extract group ID from data-groupid attribute
            var modal = $(this);
            // Set the value of the hidden input field in the modal form to the group ID
            modal.find('#group-access').val(groupKey);
            console.log(groupId)
        });
        $(document).ready(function() {
          $('.view-courses').click(function() {
              var groupId = $(this).data('groupid');
              
              // Redirect to the desired URL with the extracted course_id
              window.location.href = '/courses/' + "{{user.id}}/" + groupId;
          });
      });
        $('#button-pin').click(function(event) {
          // var groupId = $(this).data('groupid'); // Extract group ID from data-groupid attribute
          // var groupKey = $(this).data('groupkey');
          // var access = $('#group-access').val(); // Get the value of the input field with id "group-access"
          console.log(groupId, groupKey);
          // Set the value of the hidden input field in the modal form to the group ID
          // var access = modal.find('#group-access').val()
          // console.log(groupId, access)
          var jsonData = {
              "group_id": groupId,
              "user_id": "{{user.id}}",
              "group_pin": groupKey,
              // Add other data fields as needed
          };
  
          $.ajax({
              type: "POST",
              url: "/user/add-to-group",
              contentType: "application/json",
              data: JSON.stringify(jsonData),
              success: function(response) {
                  // Handle success response
                  console.log("User added to group successfully");
              },
              error: function(xhr, status, error) {
                  // Handle error response
                  console.error("Error:", error);
              }
          });
      });
    });
  </script>
{% endblock %}
